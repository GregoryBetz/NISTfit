//
//  Inspired by http://www.drdobbs.com/cpp/c11s-async-template/240001196
//  See also http://www2.imm.dtu.dk/pubdb/views/edoc_download.php/3215/pdf/imm3215.pdf
//

#include "NISTfit/abc.h"
#include "NISTfit/optimizers.h"
#include "NISTfit/numeric_evaluators.h"

#include <iostream>
#include <chrono>

using namespace NISTfit;

void fit_waterpanc() {
    
    // Theta = 1 - T/Tc
    std::vector<double> x = { 0.5778678897721512, 0.5772894434360429, 0.5767109970999347, 0.5761325507638264, 0.5755541044277181, 0.5749756580916099, 0.5743972117555017, 0.5738187654193935, 0.5732403190832851, 0.5726618727471768, 0.5720834264110686, 0.5715049800749603, 0.570926533738852, 0.5703480874027438, 0.5697696410666355, 0.5691911947305273, 0.5686127483944191, 0.5680343020583108, 0.5674558557222026, 0.5668774093860943, 0.5662989630499861, 0.5657205167138778, 0.5651420703777695, 0.5645636240416614, 0.5639851777055529, 0.5634067313694446, 0.5628282850333365, 0.5622498386972282, 0.56167139236112, 0.5610929460250117, 0.5605144996889034, 0.5599360533527952, 0.5593576070166869, 0.5587791606805788, 0.5582007143444705, 0.5576222680083622, 0.557043821672254, 0.5564653753361457, 0.5558869290000374, 0.5553084826639292, 0.5547300363278208, 0.5541515899917125, 0.5535731436556043, 0.5529946973194961, 0.5524162509833879, 0.5518378046472796, 0.5512593583111713, 0.5506809119750631, 0.5501024656389548, 0.5495240193028466, 0.5489455729667383, 0.54836712663063, 0.5477886802945218, 0.5472102339584135, 0.5466317876223052, 0.546053341286197, 0.5454748949500887, 0.5448964486139805, 0.5443180022778722, 0.5437395559417639, 0.5431611096056557, 0.5425826632695474, 0.5420042169334391, 0.5414257705973309, 0.5408473242612226, 0.5402688779251144, 0.5396904315890061, 0.5391119852528978, 0.5385335389167896, 0.5379550925806813, 0.537376646244573, 0.5367981999084648, 0.5362197535723565, 0.5356413072362483, 0.53506286090014, 0.5344844145640317, 0.5339059682279235, 0.5333275218918152, 0.5327490755557069, 0.5321706292195987, 0.5315921828834904, 0.5310137365473822, 0.5304352902112739, 0.5298568438751657, 0.5292783975390575, 0.5286999512029492, 0.528121504866841, 0.5275430585307327, 0.5269646121946243, 0.526386165858516, 0.5258077195224078, 0.5252292731862995, 0.5246508268501913, 0.5240723805140831, 0.5234939341779749, 0.5229154878418666, 0.5223370415057583, 0.5217585951696501, 0.5211801488335418, 0.5206017024974336, 0.5200232561613254, 0.5194448098252171, 0.5188663634891086, 0.5182879171530005, 0.5177094708168922, 0.517131024480784, 0.5165525781446757, 0.5159741318085674, 0.5153956854724592, 0.5148172391363509, 0.5142387928002428, 0.5136603464641345, 0.5130819001280262, 0.512503453791918, 0.5119250074558097, 0.5113465611197014, 0.5107681147835932, 0.5101896684474849, 0.5096112221113767, 0.5090327757752684, 0.5084543294391601, 0.5078758831030519, 0.5072974367669436, 0.5067189904308353, 0.5061405440947271, 0.5055620977586188, 0.5049836514225106, 0.5044052050864023, 0.503826758750294, 0.5032483124141858, 0.5026698660780775, 0.5020914197419692, 0.501512973405861, 0.5009345270697527, 0.5003560807336445, 0.4997776343975362, 0.49919918806142793, 0.49862074172531967, 0.4980422953892114, 0.49746384905310315, 0.4968854027169949, 0.4963069563808866, 0.49572851004477836, 0.4951500637086701, 0.49457161737256183, 0.49399317103645357, 0.4934147247003454, 0.49283627836423716, 0.4922578320281289, 0.49167938569202063, 0.49110093935591237, 0.490522493019804, 0.48994404668369573, 0.48936560034758747, 0.4887871540114792, 0.48820870767537095, 0.4876302613392628, 0.48705181500315453, 0.48647336866704627, 0.485894922330938, 0.48531647599482974, 0.4847380296587215, 0.4841595833226132, 0.48358113698650496, 0.4830026906503967, 0.4824242443142883, 0.48184579797818017, 0.4812673516420719, 0.48068890530596364, 0.4801104589698554, 0.4795320126337471, 0.47895356629763886, 0.4783751199615306, 0.47779667362542233, 0.47721822728931407, 0.4766397809532058, 0.47606133461709754, 0.4754828882809893, 0.474904441944881, 0.47432599560877287, 0.4737475492726646, 0.47316910293655634, 0.4725906566004481, 0.4720122102643398, 0.47143376392823144, 0.4708553175921232, 0.4702768712560149, 0.46969842491990665, 0.4691199785837984, 0.46854153224769024, 0.467963085911582, 0.4673846395754737, 0.46680619323936545, 0.4662277469032572, 0.4656493005671489, 0.46507085423104055, 0.4644924078949323, 0.46391396155882403, 0.46333551522271577, 0.4627570688866075, 0.46217862255049935, 0.4616001762143911, 0.4610217298782828, 0.46044328354217456, 0.4598648372060663, 0.45928639086995804, 0.4587079445338498, 0.4581294981977415, 0.45755105186163325, 0.456972605525525, 0.4563941591894167, 0.45581571285330846, 0.4552372665172002, 0.45465882018109205, 0.4540803738449838, 0.4535019275088754, 0.45292348117276715, 0.4523450348366589, 0.4517665885005506, 0.45118814216444236, 0.4506096958283341, 0.45003124949222584, 0.4494528031561176, 0.4488743568200094, 0.44829591048390116, 0.4477174641477929, 0.44713901781168464, 0.44656057147557626, 0.445982125139468, 0.44540367880335974, 0.4448252324672515, 0.4442467861311432, 0.44366833979503495, 0.4430898934589268, 0.44251144712281854, 0.4419330007867103, 0.441354554450602, 0.44077610811449375, 0.4401976617783855, 0.4396192154422772, 0.43904076910616896, 0.4384623227700607, 0.43788387643395243, 0.43730543009784417, 0.4367269837617359, 0.43614853742562765, 0.4355700910895195, 0.4349916447534111, 0.43441319841730286, 0.4338347520811946, 0.43325630574508633, 0.43267785940897807, 0.4320994130728698, 0.43152096673676155, 0.4309425204006533, 0.430364074064545, 0.42978562772843687, 0.4292071813923286, 0.42862873505622023, 0.42805028872011197, 0.4274718423840037, 0.42689339604789545, 0.4263149497117872, 0.4257365033756789, 0.42515805703957066, 0.4245796107034624, 0.42400116436735424, 0.423422718031246, 0.4228442716951377, 0.42226582535902946, 0.4216873790229212, 0.42110893268681293, 0.42053048635070467, 0.4199520400145964, 0.41937359367848814, 0.4187951473423799, 0.4182167010062716, 0.41763825467016336, 0.4170598083340551, 0.41648136199794683, 0.41590291566183857, 0.4153244693257303, 0.41474602298962204, 0.4141675766535138, 0.4135891303174055, 0.41301068398129726, 0.412432237645189, 0.41185379130908073, 0.41127534497297247, 0.4106968986368643, 0.41011845230075594, 0.4095400059646477, 0.4089615596285394, 0.40838311329243115, 0.4078046669563229, 0.40722622062021463, 0.40664777428410637, 0.4060693279479981, 0.40549088161188984, 0.4049124352757816, 0.4043339889396734, 0.40375554260356517, 0.4031770962674569, 0.40259864993134864, 0.4020202035952404, 0.4014417572591321, 0.40086331092302385, 0.4002848645869156, 0.3997064182508073, 0.39912797191469906, 0.3985495255785908, 0.39797107924248254, 0.3973926329063743, 0.396814186570266, 0.39623574023415775, 0.3956572938980495, 0.3950788475619412, 0.39450040122583296, 0.3939219548897247, 0.39334350855361644, 0.3927650622175082, 0.3921866158813999, 0.39160816954529165, 0.3910297232091834, 0.3904512768730751, 0.38987283053696686, 0.3892943842008586, 0.38871593786475034, 0.3881374915286421, 0.3875590451925338, 0.38698059885642555, 0.3864021525203173, 0.385823706184209, 0.3852452598481009, 0.3846668135119926, 0.38408836717588435, 0.3835099208397761, 0.3829314745036678, 0.38235302816755956, 0.3817745818314513, 0.38119613549534304, 0.38061768915923466, 0.3800392428231265, 0.37946079648701825, 0.37888235015091, 0.3783039038148017, 0.37772545747869346, 0.3771470111425852, 0.37656856480647694, 0.3759901184703687, 0.3754116721342604, 0.37483322579815204, 0.3742547794620438, 0.3736763331259356, 0.37309788678982736, 0.3725194404537191, 0.37194099411761083, 0.37136254778150257, 0.3707841014453943, 0.37020565510928605, 0.3696272087731778, 0.3690487624370695, 0.36847031610096126, 0.367891869764853, 0.36731342342874473, 0.36673497709263647, 0.3661565307565283, 0.36557808442042006, 0.3649996380843118, 0.36442119174820353, 0.36384274541209527, 0.363264299075987, 0.36268585273987874, 0.3621074064037705, 0.3615289600676622, 0.36095051373155385, 0.3603720673954457, 0.35979362105933743, 0.35921517472322917, 0.3586367283871209, 0.35805828205101264, 0.3574798357149044, 0.3569013893787961, 0.35632294304268775, 0.3557444967065795, 0.3551660503704712, 0.35458760403436307, 0.3540091576982548, 0.35343071136214654, 0.3528522650260383, 0.35227381868993, 0.35169537235382176, 0.3511169260177135, 0.35053847968160523, 0.34996003334549697, 0.3493815870093887, 0.34880314067328044, 0.3482246943371722, 0.3476462480010639, 0.34706780166495577, 0.3464893553288475, 0.34591090899273924, 0.345332462656631, 0.3447540163205227, 0.34417556998441445, 0.3435971236483062, 0.3430186773121978, 0.34244023097608955, 0.3418617846399813, 0.34128333830387303, 0.3407048919677649, 0.3401264456316566, 0.33954799929554835, 0.3389695529594401, 0.3383911066233317, 0.33781266028722345, 0.3372342139511152, 0.33665576761500693, 0.33607732127889867, 0.3354988749427904, 0.33492042860668225, 0.334341982270574, 0.3337635359344657, 0.33318508959835746, 0.3326066432622492, 0.33202819692614094, 0.3314497505900327, 0.3308713042539244, 0.33029285791781615, 0.3297144115817079, 0.3291359652455996, 0.32855751890949136, 0.3279790725733831, 0.32740062623727495, 0.3268221799011667, 0.3262437335650584, 0.32566528722895016, 0.3250868408928419, 0.3245083945567335, 0.32392994822062526, 0.323351501884517, 0.32277305554840874, 0.3221946092123005, 0.3216161628761923, 0.32103771654008406, 0.3204592702039758, 0.3198808238678674, 0.31930237753175916, 0.3187239311956509, 0.31814548485954264, 0.3175670385234344, 0.3169885921873261, 0.31641014585121785, 0.3158316995151097, 0.31525325317900144, 0.3146748068428932, 0.3140963605067849, 0.31351791417067665, 0.3129394678345684, 0.3123610214984601, 0.31178257516235186, 0.3112041288262436, 0.31062568249013534, 0.3100472361540271, 0.3094687898179188, 0.30889034348181055, 0.3083118971457024, 0.30773345080959413, 0.30715500447348587, 0.3065765581373775, 0.30599811180126923, 0.30541966546516097, 0.3048412191290527, 0.30426277279294445, 0.3036843264568362, 0.3031058801207279, 0.30252743378461977, 0.3019489874485114, 0.30137054111240313, 0.30079209477629487, 0.3002136484401866, 0.29963520210407835, 0.2990567557679701, 0.2984783094318618, 0.29789986309575356, 0.2973214167596453, 0.29674297042353714, 0.2961645240874289, 0.2955860777513206, 0.29500763141521236, 0.2944291850791041, 0.29385073874299583, 0.29327229240688757, 0.2926938460707793, 0.29211539973467104, 0.2915369533985628, 0.2909585070624545, 0.29038006072634626, 0.289801614390238, 0.28922316805412984, 0.2886447217180216, 0.2880662753819132, 0.28748782904580494, 0.2869093827096967, 0.2863309363735884, 0.28575249003748016, 0.2851740437013719, 0.28459559736526363, 0.28401715102915537, 0.2834387046930471, 0.28286025835693884, 0.2822818120208306, 0.2817033656847223, 0.28112491934861406, 0.2805464730125058, 0.27996802667639753, 0.27938958034028927, 0.278811134004181, 0.27823268766807274, 0.2776542413319645, 0.27707579499585633, 0.27649734865974807, 0.2759189023236398, 0.27534045598753154, 0.2747620096514233, 0.274183563315315, 0.27360511697920675, 0.2730266706430985, 0.2724482243069902, 0.27186977797088197, 0.2712913316347737, 0.27071288529866544, 0.2701344389625572, 0.2695559926264489, 0.26897754629034065, 0.2683990999542324, 0.2678206536181241, 0.26724220728201586, 0.2666637609459076, 0.26608531460979934, 0.2655068682736911, 0.2649284219375828, 0.26434997560147455, 0.2637715292653663, 0.263193082929258, 0.26261463659314976, 0.2620361902570415, 0.26145774392093324, 0.260879297584825, 0.2603008512487167, 0.25972240491260845, 0.2591439585765002, 0.2585655122403919, 0.2579870659042838, 0.2574086195681755, 0.25683017323206725, 0.256251726895959, 0.2556732805598507, 0.25509483422374246, 0.2545163878876342, 0.25393794155152594, 0.2533594952154177, 0.2527810488793094, 0.25220260254320115, 0.2516241562070929, 0.2510457098709846, 0.25046726353487636, 0.2498888171987681, 0.24931037086265984, 0.24873192452655157, 0.2481534781904433, 0.24757503185433505, 0.24699658551822667, 0.24641813918211852, 0.24583969284601026, 0.245261246509902, 0.24468280017379374, 0.24410435383768547, 0.2435259075015772, 0.24294746116546895, 0.24236901482936068, 0.24179056849325242, 0.24121212215714416, 0.2406336758210359, 0.24005522948492763, 0.23947678314881937, 0.23889833681271122, 0.23831989047660296, 0.2377414441404947, 0.23716299780438643, 0.23658455146827817, 0.2360061051321699, 0.23542765879606165, 0.23484921245995338, 0.23427076612384512, 0.23369231978773675, 0.2331138734516286, 0.23253542711552033, 0.23195698077941207, 0.2313785344433038, 0.23080008810719554, 0.23022164177108728, 0.22964319543497902, 0.22906474909887065, 0.22848630276276238, 0.22790785642665412, 0.22732941009054586, 0.2267509637544377, 0.22617251741832944, 0.22559407108222118, 0.22501562474611292, 0.22443717841000466, 0.2238587320738964, 0.22328028573778813, 0.22270183940167987, 0.2221233930655716, 0.22154494672946334, 0.22096650039335508, 0.22038805405724682, 0.21980960772113867, 0.2192311613850304, 0.21865271504892214, 0.21807426871281388, 0.21749582237670562, 0.21691737604059735, 0.2163389297044891, 0.21576048336838083, 0.21518203703227246, 0.2146035906961642, 0.21402514436005593, 0.21344669802394778, 0.21286825168783952, 0.21228980535173125, 0.211711359015623, 0.21113291267951473, 0.21055446634340635, 0.2099760200072981, 0.20939757367118983, 0.20881912733508157, 0.2082406809989733, 0.20766223466286515, 0.2070837883267569, 0.20650534199064863, 0.20592689565454037, 0.2053484493184321, 0.20477000298232384, 0.20419155664621558, 0.20361311031010731, 0.20303466397399905, 0.2024562176378908, 0.20187777130178253, 0.20129932496567426, 0.200720878629566, 0.20014243229345785, 0.1995639859573496, 0.19898553962124133, 0.19840709328513306, 0.1978286469490248, 0.19725020061291654, 0.19667175427680805, 0.1960933079407, 0.19551486160459164, 0.1949364152684835, 0.1943579689323751, 0.19377952259626696, 0.1932010762601586, 0.19262262992405033, 0.19204418358794206, 0.1914657372518338, 0.19088729091572554, 0.19030884457961728, 0.189730398243509, 0.18915195190740075, 0.1885735055712926, 0.18799505923518434, 0.18741661289907607, 0.1868381665629678, 0.18625972022685955, 0.18568127389075129, 0.18510282755464302, 0.18452438121853476, 0.1839459348824265, 0.18336748854631824, 0.18278904221020997, 0.1822105958741017, 0.18163214953799345, 0.18105370320188507, 0.18047525686577703, 0.17989681052966855, 0.1793183641935605, 0.17873991785745202, 0.17816147152134398, 0.1775830251852355, 0.17700457884912746, 0.17642613251301908, 0.17584768617691093, 0.17526923984080256, 0.1746907935046944, 0.17411234716858603, 0.173533900832478, 0.1729554544963695, 0.17237700816026147, 0.17179856182415298, 0.17122011548804472, 0.17064166915193646, 0.1700632228158282, 0.16948477647972005, 0.16890633014361178, 0.16832788380750352, 0.16774943747139526, 0.167170991135287, 0.16659254479917873, 0.16601409846307047, 0.1654356521269622, 0.16485720579085394, 0.16427875945474568, 0.16370031311863742, 0.16312186678252905, 0.1625434204464209, 0.16196497411031252, 0.16138652777420448, 0.160808081438096, 0.16022963510198796, 0.15965118876587947, 0.15907274242977143, 0.15849429609366295, 0.1579158497575549, 0.15733740342144653, 0.15675895708533838, 0.15618051074923, 0.15560206441312185, 0.15502361807701348, 0.15444517174090544, 0.15386672540479696, 0.1532882790686887, 0.15270983273258043, 0.15213138639647217, 0.1515529400603639, 0.15097449372425564, 0.15039604738814738, 0.14981760105203923, 0.14923915471593097, 0.1486607083798227, 0.14808226204371444, 0.14750381570760618, 0.14692536937149792, 0.14634692303538965, 0.1457684766992814, 0.14519003036317313, 0.14461158402706487, 0.1440331376909565, 0.14345469135484834, 0.14287624501873997, 0.14229779868263193, 0.14171935234652344, 0.1411409060104154, 0.14056245967430692, 0.13998401333819888, 0.1394055670020904, 0.13882712066598235, 0.13824867432987398, 0.13767022799376583, 0.13709178165765745, 0.1365133353215493, 0.13593488898544093, 0.13535644264933266, 0.1347779963132244, 0.13419954997711614, 0.13362110364100788, 0.13304265730489961, 0.13246421096879135, 0.1318857646326831, 0.13130731829657483, 0.13072887196046667, 0.1301504256243584, 0.12957197928825015, 0.1289935329521419, 0.12841508661603362, 0.12783664027992536, 0.1272581939438171, 0.12667974760770884, 0.12610130127160046, 0.1255228549354923, 0.12494440859938394, 0.12436596226327579, 0.12378751592716741, 0.12320906959105937, 0.12263062325495089, 0.12205217691884285, 0.12147373058273436, 0.12089528424662632, 0.12031683791051784, 0.1197383915744098, 0.11915994523830142, 0.11858149890219327, 0.1180030525660849, 0.11742460622997664, 0.11684615989386837, 0.11626771355776011, 0.11568926722165185, 0.11511082088554359, 0.11453237454943532, 0.11395392821332706, 0.1133754818772188, 0.11279703554111054, 0.11221858920500227, 0.11164014286889412, 0.11106169653278586, 0.1104832501966776, 0.10990480386056933, 0.10932635752446107, 0.10874791118835281, 0.10816946485224432, 0.10759101851613628, 0.10701257218002791, 0.10643412584391976, 0.10585567950781138, 0.10527723317170323, 0.10469878683559486, 0.10412034049948682, 0.10354189416337833, 0.1029634478272703, 0.10238500149116181, 0.10180655515505377, 0.10122810881894528, 0.10064966248283724, 0.10007121614672876, 0.09949276981062072, 0.09891432347451234, 0.09833587713840408, 0.09775743080229582, 0.09717898446618756, 0.0966005381300793, 0.09602209179397103, 0.09544364545786277, 0.0948651991217545, 0.09428675278564624, 0.09370830644953798, 0.09312986011342972, 0.09255141377732146, 0.0919729674412133, 0.09139452110510504, 0.09081607476899678, 0.0902376284328883, 0.08965918209678025, 0.08908073576067177, 0.08850228942456373, 0.08792384308845536, 0.0873453967523472, 0.08676695041623883, 0.08618850408013068, 0.0856100577440223, 0.08503161140791426, 0.08445316507180578, 0.08387471873569774, 0.08329627239958926, 0.08271782606348121, 0.08213937972737273, 0.08156093339126469, 0.0809824870551562, 0.08040404071904805, 0.07982559438293979, 0.07924714804683153, 0.07866870171072327, 0.078090255374615, 0.07751180903850674, 0.07693336270239848, 0.07635491636629022, 0.07577647003018195, 0.07519802369407369, 0.07461957735796543, 0.07404113102185716, 0.0734626846857489, 0.07288423834964075, 0.07230579201353249, 0.07172734567742423, 0.07114889934131574, 0.0705704530052077, 0.06999200666909922, 0.06941356033299118, 0.0688351139968828, 0.06825666766077465, 0.06767822132466628, 0.06709977498855813, 0.06652132865244975, 0.0659428823163416, 0.06536443598023323, 0.06478598964412519, 0.0642075433080167, 0.06362909697190866, 0.06305065063580018, 0.062472204299691914, 0.06189375796358365, 0.0613153116274755, 0.06073686529136724, 0.060158418955258974, 0.05957997261915071, 0.05900152628304245, 0.05842307994693419, 0.057844633610825924, 0.05726618727471766, 0.0566877409386094, 0.056109294602501136, 0.055530848266392874, 0.05495240193028461, 0.05437395559417635, 0.0537955092580682, 0.05321706292195971, 0.05263861658585167, 0.05206017024974319, 0.05148172391363515, 0.05090327757752666, 0.05032483124141862, 0.04974638490531014, 0.049167938569202096, 0.04858949223309372, 0.04801104589698557, 0.0474325995608772, 0.046854153224769046, 0.04627570688866067, 0.04569726055255263, 0.04511881421644415, 0.044540367880335885, 0.04396192154422762, 0.04338347520811936, 0.0428050288720111, 0.042226582535902946, 0.04164813619979468, 0.04106968986368642, 0.04049124352757816, 0.039912797191469895, 0.03933435085536163, 0.03875590451925337, 0.03817745818314511, 0.037599011847036845, 0.03702056551092858, 0.03644211917482032, 0.03586367283871206, 0.035285226502603684, 0.03470678016649564, 0.03412833383038716, 0.03354988749427912, 0.032971441158170633, 0.03239299482206259, 0.03181454848595411, 0.031236102149846068, 0.030657655813737583, 0.030079209477629543, 0.02950076314152117, 0.028922316805413018, 0.028343870469304644, 0.027765424133196492, 0.02718697779708812, 0.026608531460980078, 0.026030085124871594, 0.02545163878876333, 0.02487319245265507, 0.024294746116546806, 0.023716299780438543, 0.02313785344433028, 0.02255940710822213, 0.021980960772113867, 0.021402514436005604, 0.02082406809989734, 0.02024562176378908, 0.019667175427680816, 0.019088729091572554, 0.01851028275546429, 0.01793183641935603, 0.017353390083247655, 0.016774943747139504, 0.01619649741103113, 0.015618051074922978, 0.015039604738814605, 0.014461158402706564, 0.01388271206659808, 0.013304265730490039, 0.012725819394381555, 0.012147373058273514, 0.01156892672216503, 0.010990480386056989, 0.010412034049948615, 0.009833587713840464, 0.00925514137773209, 0.008676695041623939, 0.008098248705515565, 0.007519802369407302, 0.00694135603329904, 0.006362909697190777, 0.005784463361082515, 0.005206017024974252, 0.0046275706888659895, 0.004049124352757727, 0.0034706780166495754, 0.002892231680541313, 0.0023137853444330503, 0.0017353390083247877, 0.0011568926722165251, 0.0005784463361082626, 0.0 };
    // LHS = ln(p/pc)*T/Tc
    std::vector<double> y = { -4.429554569233974, -4.42414462890585, -4.418738634318916, -4.413336595960673, -4.407938461596972, -4.402544351165497, -4.397154163783688, -4.391767914847221, -4.3863855651761, -4.381007147725776, -4.37563259362438, -4.370261978454665, -4.364895246341587, -4.3595324345504025, -4.354173447059139, -4.348818289729066, -4.343467101464804, -4.338119689066857, -4.332776093574267, -4.327436433558225, -4.322100514547465, -4.316768434871701, -4.311440173640952, -4.306115701183846, -4.300795022961535, -4.295478164428675, -4.290165085141307, -4.284855722870837, -4.2795501898114745, -4.274248398229086, -4.268950384886277, -4.263656040946082, -4.2583654892460645, -4.2530786547994825, -4.247795537895779, -4.242516130990645, -4.237240455374811, -4.2319684550652985, -4.226700170089877, -4.221435557922192, -4.216174637255422, -4.210917380698687, -4.2056637788157625, -4.200413858118755, -4.1951675685613905, -4.189924944555934, -4.184685962914597, -4.179450561128983, -4.174218855815315, -4.168990723561045, -4.163766199425473, -4.158545282720654, -4.1533279728962835, -4.148114250370302, -4.142904121538461, -4.137697551808611, -4.132494559034137, -4.127295116756592, -4.122099260385506, -4.116906921260238, -4.111718136078554, -4.10653290471995, -4.101351182754399, -4.096172996240599, -4.090998311015565, -4.085827135221542, -4.0806594817981345, -4.075495311078799, -4.070334637110578, -4.06517743725087, -4.060023735365084, -4.05487347973139, -4.049726699800258, -4.044583372935198, -4.039443509710619, -4.034307075775465, -4.029174093105352, -4.0240445316938205, -4.01891840083725, -4.0137956853514645, -4.008676384003002, -4.003560489750089, -3.9984479948555305, -3.993338890050138, -3.988233178073746, -3.98313084069825, -3.9780318821444514, -3.97293628578696, -3.9678440558446844, -3.962755180426522, -3.957669650188768, -3.9525874602669844, -3.9475086139898954, -3.942433091623897, -3.93736089245924, -3.932292012946996, -3.92722644238683, -3.922164174069697, -3.917105206138435, -3.912049528800438, -3.906997137618417, -3.901948024613951, -3.89690218397765, -3.891859610774305, -3.8868202970462935, -3.881784235574688, -3.876751426499576, -3.8717218529134274, -3.8666955185536294, -3.8616724089584635, -3.8566525228766055, -3.8516358549193606, -3.8466223958705212, -3.84161213899589, -3.836605083902524, -3.8316012148913154, -3.8266005340303333, -3.821603030736056, -3.816608696469608, -3.8116175349882506, -3.806629528771828, -3.8016446767510605, -3.7966629733224266, -3.7916844104418685, -3.786708981846676, -3.7817366823573835, -3.776767503435709, -3.7718014439349097, -3.7668384951320655, -3.7618786472997554, -3.7569218976080703, -3.7519682403316525, -3.747017667145253, -3.7420701735130084, -3.7371257519314764, -3.732184397764917, -3.7272461023716343, -3.7223108618915997, -3.717378669560724, -3.7124495178924897, -3.70752340328289, -3.702600315784298, -3.6976802515849228, -3.692763204560526, -3.68784916853725, -3.6829381357821482, -3.6780301026386653, -3.673125060262172, -3.668223002617472, -3.663323925748593, -3.65842782194084, -3.653534684727049, -3.6486445099306133, -3.6437572873767077, -3.6388730143868955, -3.6339916838056987, -3.6291132884233535, -3.624237823542119, -3.619365282051907, -3.6144956579546204, -3.6096289453116213, -3.6047651372063156, -3.599904228030787, -3.5950462116792745, -3.5901910810417035, -3.585338831089144, -3.5804894549173727, -3.575642946536288, -3.570799299963524, -3.5659585080946643, -3.5611205656009886, -3.556285466443563, -3.5514532035593107, -3.546623771336749, -3.5417971635227734, -3.5369733737339364, -3.532152395891133, -3.527334224131868, -3.5225188512038996, -3.517706271983931, -3.512896479986779, -3.5080894686117126, -3.5032852319796794, -3.498483764117603, -3.4936850584856627, -3.48888910898665, -3.4840959093726465, -3.479305453450387, -3.474517734984271, -3.469732748033077, -3.464950486026581, -3.4601709431618817, -3.4553941129561148, -3.4506199892467024, -3.445848565882561, -3.44107983655056, -3.436313795484515, -3.4315504359749895, -3.4267897520629136, -3.422031737569849, -3.4172763861857485, -3.412523691825898, -3.4077736484221046, -3.4030262493100256, -3.3982814887157713, -3.3935393606068094, -3.3887998582170433, -3.3840629759948575, -3.3793287070035003, -3.374597045722724, -3.3698679856193565, -3.365141520944283, -3.3604176449191745, -3.355696351707059, -3.3509776350480727, -3.3462614886938535, -3.3415479067146987, -3.3368368826141563, -3.332128410373427, -3.3274224838156687, -3.322719096783942, -3.3180182430215703, -3.313319916395361, -3.308624110712036, -3.3039308198493775, -3.299240037623298, -3.2945517578140007, -3.289865974360146, -3.285182680978543, -3.280501871585881, -3.275823539966844, -3.2711476800673127, -3.266474285495772, -3.261803350310313, -3.257134868258347, -3.2524688332580123, -3.2478052391127856, -3.2431440796938573, -3.238485348704331, -3.23382904025564, -3.2291751479020703, -3.2245236657909864, -3.2198745875870936, -3.215227907211799, -3.210583618533429, -3.205941715413397, -3.2013021916802518, -3.1966650412811375, -3.192030258017621, -3.1873978357370536, -3.182767768407103, -3.178140049873007, -3.173514673905216, -3.1688916345162306, -3.1642709255361727, -3.1596525408631493, -3.155036474333239, -3.150422719964714, -3.145811271530657, -3.14120212296301, -3.1365952681435356, -3.1319907009936947, -3.1273884154334213, -3.1227884053187833, -3.118190664623447, -3.1135951872280536, -3.1090019670490983, -3.1044109979471632, -3.0998222739205343, -3.0952357888959123, -3.090651536743262, -3.086069511444254, -3.0814897068708436, -3.076912117002987, -3.0723367357536753, -3.0677635571535533, -3.0631925749848885, -3.0586237833557233, -3.0540571761409026, -3.0494927472905906, -3.0449304908083707, -3.0403704005950396, -3.0358124706616767, -3.031256694988147, -3.0267030675232807, -3.0221515821935587, -3.0176022331034584, -3.013055014136872, -3.0085099193294136, -3.003966942620627, -2.9994260780815347, -2.994887319649365, -2.990350661378285, -2.9858160972436365, -2.981283621243865, -2.9767532274467285, -2.972224909799059, -2.9676986624524377, -2.9631744792656445, -2.9586523543842516, -2.954132281791644, -2.9496142556257, -2.9450982698020876, -2.9405843184462106, -2.936072395602411, -2.931562495324575, -2.9270546116728267, -2.9225487387351454, -2.9180448705614626, -2.9135430012256616, -2.9090431248215425, -2.9045452354616814, -2.9000493271950196, -2.895555394121827, -2.8910634303924443, -2.8865734300287094, -2.8820853872319057, -2.8775992960727668, -2.873115150693242, -2.868632945199951, -2.8641526737153016, -2.859674330398352, -2.85519790937344, -2.8507234048133956, -2.8462508108532436, -2.8417801216530107, -2.8373113313257226, -2.8328444341304255, -2.8283794242144924, -2.8239162957094814, -2.81945504282552, -2.814995659775153, -2.8105381407424765, -2.806082479916475, -2.8016286715208434, -2.797176709757386, -2.7927265888094173, -2.7882783029505713, -2.783831846405971, -2.779387213380962, -2.77494439814097, -2.770503394948336, -2.766064197994861, -2.7616268016005727, -2.7571911999882164, -2.7527573874620086, -2.748325358280975, -2.743895106719773, -2.7394666270952013, -2.7350399136429373, -2.7306149607172983, -2.726191762627268, -2.7217703136435434, -2.717350608126335, -2.7129326403651195, -2.708516404730347, -2.704101895526314, -2.6996891071090476, -2.695278033827925, -2.6908686700258007, -2.686461010112877, -2.682055048416388, -2.6776507792958744, -2.6732481971944386, -2.668847296442525, -2.664448071459159, -2.6600505166445885, -2.6556546264068017, -2.6512603951652554, -2.646867817331575, -2.642476887337647, -2.6380875996207847, -2.6336999486403267, -2.629313928807235, -2.6249295345774364, -2.620546760441451, -2.6161656008502496, -2.6117860502802053, -2.6074081032312977, -2.6030317541520103, -2.5986569975716094, -2.594283827975599, -2.589912239902554, -2.5855422278055378, -2.5811737862701287, -2.5768069097904793, -2.57244159289734, -2.5680778301790674, -2.5637156161474937, -2.5593549453598183, -2.55499581238702, -2.5506382118134945, -2.5462821382082286, -2.541927586147703, -2.5375745502282574, -2.5332230250515773, -2.5288730052245456, -2.5245244853536386, -2.520177460076641, -2.5158319240046807, -2.5114878717788076, -2.50714529803545, -2.5028041974254753, -2.4984645646071835, -2.494126394245719, -2.4897896810011426, -2.4854544195625965, -2.4811206046034266, -2.4767882308303535, -2.472457292927298, -2.468127785617985, -2.463799703584528, -2.459473041578023, -2.455147794301927, -2.450823956514852, -2.446501522945251, -2.442180488346317, -2.437860847470027, -2.4335425950841, -2.42922572595958, -2.4249102348650533, -2.4205961165995853, -2.416283365951266, -2.4119719777171746, -2.4076619467024, -2.4033532677164526, -2.3990459356043417, -2.394739945169081, -2.3904352912592173, -2.3861319687118216, -2.3818299723844625, -2.3775292971306587, -2.3732299378117303, -2.368931889303085, -2.364635146488653, -2.3603397042474734, -2.356045557475082, -2.351752701074798, -2.3474611299554495, -2.343170839030172, -2.3388818232247135, -2.3345940774552925, -2.330307596679587, -2.326022375829413, -2.321738409862025, -2.3174556937276654, -2.3131742224006975, -2.308893990845345, -2.304614994055978, -2.3003372270030957, -2.2960606846898317, -2.2917853621178854, -2.2875112542916645, -2.2832383562325527, -2.278966662958044, -2.274696169499481, -2.27042687089847, -2.266158762189734, -2.2618918384374287, -2.2576260946881557, -2.253361526007399, -2.2490981274783355, -2.244835894166736, -2.2405748211676233, -2.2363149035712837, -2.2320561364774325, -2.2277985149930055, -2.2235420342402707, -2.2192866893319945, -2.2150324753927086, -2.2107793875650774, -2.206527420988956, -2.202276570810601, -2.1980268321911267, -2.193778200285166, -2.189530670267811, -2.1852842373162225, -2.1810388966094414, -2.1767946433385434, -2.172551472695446, -2.1683093798901516, -2.16406836013222, -2.1598284086337247, -2.1555895206214393, -2.1513516913256954, -2.1471149159785923, -2.1428791898306985, -2.1386445081249095, -2.1344108661213843, -2.1301782590809357, -2.125946682277054, -2.121716130984077, -2.1174866004822332, -2.1132580860612715, -2.10903058302087, -2.1048040866604762, -2.1005785922864684, -2.0963540952156636, -2.0921305907722143, -2.0879080742774385, -2.0836865410732903, -2.0794659864923957, -2.075246405884386, -2.0710277946012003, -2.066810148005553, -2.062593461459611, -2.058377730334146, -2.054162950006311, -2.0499491158614638, -2.0457362232918457, -2.0415242676879086, -2.037313244454966, -2.0331031489997162, -2.028893976736985, -2.0246857230878295, -2.0204783834749125, -2.016271953332053, -2.0120664280953617, -2.0078618032107576, -2.003658074124797, -1.9994552362952396, -1.9952532851814067, -1.991052216249021, -1.9868520249720854, -1.9826527068296678, -1.978454257300544, -1.974256671878836, -1.9700599460564725, -1.965864075335718, -1.9616690552209899, -1.957474881224372, -1.953281548862011, -1.9490890536560643, -1.9448973911366987, -1.9407065568320196, -1.9365165462821141, -1.9323273550331759, -1.9281389786317895, -1.9239514126315025, -1.9197646525908867, -1.9155786940768451, -1.9113935326568086, -1.9072091639049373, -1.903025583401545, -1.89884278673123, -1.8946607694821576, -1.8904795272495671, -1.886299055633388, -1.8821193502355507, -1.8779404066667034, -1.873762220539803, -1.869584787473307, -1.8654081030894762, -1.8612321630166053, -1.8570569628870712, -1.8528824983377254, -1.8487087650104665, -1.8445357585501536, -1.8403634746070021, -1.836191908835535, -1.8320210568964745, -1.8278509144508563, -1.8236814771681298, -1.8195127407187748, -1.8153447007801806, -1.8111773530313664, -1.8070106931576406, -1.8028447168460313, -1.798679419789851, -1.7945147976853622, -1.7903508462333488, -1.7861875611372282, -1.7820249381046411, -1.777862972847599, -1.77370166108192, -1.7695409985264847, -1.7653809809035914, -1.761221603940392, -1.757062863366888, -1.752904754915889, -1.7487472743247476, -1.7445904173332443, -1.7404341796863958, -1.7362785571291846, -1.732123545412683, -1.7279691402580077, -1.723815337491361, -1.7196621328341395, -1.7155095220498675, -1.7113575009029853, -1.7072060651624286, -1.703055210600222, -1.6989049329901451, -1.6947552281098506, -1.6906060917384387, -1.686457519658802, -1.6823095076561716, -1.678162051518633, -1.6740151470353495, -1.669868790000364, -1.6657229762063206, -1.6615777014520063, -1.6574329615371937, -1.6532887522637756, -1.649145069434365, -1.6450019088566539, -1.6408592663372066, -1.6367171376868062, -1.6325755187170456, -1.6284344052422093, -1.6242937930773345, -1.6201536780402142, -1.6160140559495648, -1.6118749226263331, -1.6077362738917707, -1.6035981055702389, -1.5994604134859098, -1.5953231934658503, -1.5911864413377979, -1.5870501529300978, -1.5829143240723167, -1.5787789505966514, -1.5746440283339096, -1.5705095531185593, -1.566375520783273, -1.5622419271633912, -1.5581087680942403, -1.5539760394121735, -1.5498437369528306, -1.5457118565545858, -1.541580394055002, -1.537449345291606, -1.5333187061030868, -1.5291884723281177, -1.5250586398059818, -1.520929204414335, -1.5168001619187055, -1.5126715081927016, -1.5085432390744549, -1.5044153504029192, -1.5002878380163742, -1.4961606977523563, -1.492033925448199, -1.4879075169409899, -1.4837814680665276, -1.4796557746612404, -1.4755304325584235, -1.4714054375932812, -1.4672807855981629, -1.4631564724044437, -1.459032493844248, -1.4549088457458597, -1.4507855239385983, -1.446662524248672, -1.4425398425014266, -1.438417474521545, -1.4342954161309023, -1.4301736631500246, -1.4260522113977347, -1.421931056690767, -1.4178101948436148, -1.4136896216697654, -1.4095693329793735, -1.4054493245806114, -1.4013295922790856, -1.397210131878678, -1.3930909391801658, -1.3889720099813931, -1.3848533400776823, -1.3807349252620962, -1.3766167613235794, -1.3724988440484776, -1.3683811692208465, -1.3642637326195977, -1.3601465300222735, -1.3560295572013819, -1.3519128099268878, -1.3477962839641013, -1.3436799750749355, -1.3395638790179039, -1.3354479915470523, -1.3313323084117101, -1.3272168253573244, -1.3231015381261562, -1.3189864424540505, -1.3148715340735846, -1.310756808711821, -1.3066422620915281, -1.3025278899302672, -1.2984136879405148, -1.2942996518296188, -1.290185777299647, -1.286072060047141, -1.2819584957629924, -1.277845080132105, -1.2737318088346001, -1.2696186775433882, -1.2655056819262407, -1.2613928176443254, -1.2572800803523643, -1.2531674656984693, -1.2490549693247683, -1.2449425868661486, -1.2408303139503287, -1.2367181461985313, -1.232606079224902, -1.2284941086357617, -1.224382230029829, -1.220270438999736, -1.21615873112783, -1.212047101990735, -1.207935547156487, -1.2038240621835299, -1.1997126426241156, -1.1956012840210652, -1.1914899819076055, -1.18737873180977, -1.183267529243687, -1.1791563697161376, -1.1750452487254233, -1.1709341617593585, -1.1668231042972919, -1.162712071807787, -1.158601059750039, -1.1544900635730968, -1.150379078715172, -1.1462681006045319, -1.1421571246582076, -1.1380461462832367, -1.133935160875033, -1.1298241638180162, -1.1257131504849527, -1.121602116237221, -1.117491056424736, -1.1133799663847797, -1.1092688414433676, -1.105157676913545, -1.1010464680957501, -1.0969352102781236, -1.0928238987356067, -1.0887125287300607, -1.084601095510057, -1.0804895943105148, -1.0763780203526685, -1.072266368843485, -1.0681546349762412, -1.0640428139295994, -1.0599309008673024, -1.055818890938447, -1.0517067792774006, -1.0475945610023563, -1.0434822312168799, -1.0393697850082282, -1.0352572174475765, -1.0311445235902534, -1.0270316984745966, -1.022918737122747, -1.0188056345392906, -1.0146923857117753, -1.0105789856105165, -1.0064654291875155, -1.0023517113771008, -0.9982378270953417, -0.9941237712395957, -0.9900095386883906, -0.9858951243009865, -0.9817805229176181, -0.9776657293585141, -0.9735507384239973, -0.9694355448943075, -0.9653201435287607, -0.9612045290662824, -0.9570886962242454, -0.952972639698626, -0.9488563541636712, -0.9447398342717306, -0.9406230746522686, -0.9365060699124168, -0.9323888146359446, -0.9282713033835113, -0.9241535306916011, -0.92003549107309, -0.9159171790159398, -0.9117985889835839, -0.9076797154144071, -0.9035605527207609, -0.8994410952896941, -0.8953213374815202, -0.8912012736301832, -0.8870808980425026, -0.8829602049976345, -0.8788391887472885, -0.8747178435146925, -0.8705961634944007, -0.8664741428519062, -0.8623517757232435, -0.8582290562144801, -0.8541059784015633, -0.8499825363290013, -0.845858724010625, -0.8417345354283056, -0.8376099645316396, -0.8334850052377543, -0.8293596514302783, -0.8252338969596067, -0.8211077356416339, -0.8169811612577046, -0.8128541675540659, -0.8087267482410753, -0.8045988969931204, -0.800470607447528, -0.7963418732043203, -0.7922126878259445, -0.7880830448359669, -0.7839529377190035, -0.7798223599201469, -0.775691304844066, -0.7715597658547202, -0.7674277362743339, -0.7632952093833201, -0.7591621784190705, -0.7550286365755006, -0.7508945770024735, -0.7467599928051926, -0.7426248770430571, -0.7384892227294427, -0.7343530228307803, -0.7302162702657565, -0.7260789579045136, -0.7219410785682472, -0.7178026250278682, -0.7136635900036822, -0.7095239661644648, -0.7053837461263266, -0.7012429224522395, -0.6971014876509631, -0.6929594341763888, -0.6888167544263882, -0.6846734407419738, -0.6805294854064461, -0.6763848806443561, -0.6722396186205636, -0.6680936914393908, -0.6639470911432757, -0.6597998097121476, -0.6556518390620297, -0.6515031710441396, -0.6473537974437724, -0.6432037099793085, -0.6390529003006945, -0.6349013599888251, -0.6307490805538122, -0.6265960534343475, -0.6224422699957324, -0.6182877215293634, -0.6141323992511681, -0.6099762942999603, -0.6058193977367952, -0.6016617005429055, -0.597503193618786, -0.5933438677824455, -0.5891837137683655, -0.585022722225699, -0.5808608837168061, -0.5766981887159205, -0.5725346276071802, -0.5683701906398123, -0.564204868104359, -0.5600386500589398, -0.5558715265122964, -0.5517034873751353, -0.547534522458362, -0.5433646214712752, -0.5391937740196884, -0.5350219696041951, -0.5308491976182272, -0.5266754473461885, -0.5225007079615356, -0.5183249685246422, -0.5141482179811494, -0.5099704451594296, -0.5057916387689821, -0.5016117873981297, -0.49743087951183834, -0.49324890344955935, -0.48906584742333015, -0.48488169951510174, -0.4806964476747314, -0.476510079717803, -0.47232258332303695, -0.468133946030173, -0.46394415523763605, -0.459753198199832, -0.4555610620251568, -0.45136773367319677, -0.4471731999526247, -0.44297744751828166, -0.4387804628691242, -0.43458223234536913, -0.43038274212619854, -0.4261819782271235, -0.4219799264971041, -0.41777657261665246, -0.41357190209456335, -0.4093659002657836, -0.40515855228855335, -0.4009498431417939, -0.3967397576225864, -0.3925282803434952, -0.38831539572992924, -0.38410108801744863, -0.37988534124916157, -0.3756681392730946, -0.37144946573935766, -0.3672293040977252, -0.36300763759461663, -0.35878444927065206, -0.3545597219576864, -0.3503334382762096, -0.34610558063236535, -0.3418761312151409, -0.3376450719933996, -0.3334123847129042, -0.3291780508930795, -0.3249420518237525, -0.32070436856189033, -0.3164649819277274, -0.3122238725012439, -0.3079810206177775, -0.3037364063637893, -0.29949000957203825, -0.29524180981621795, -0.29099178640539375, -0.2867399183773568, -0.28248618449166774, -0.27823056322156675, -0.27397303274503937, -0.2697135709345702, -0.26545215534571187, -0.2611887632039942, -0.25692337138987825, -0.2526559564218251, -0.24838649443683491, -0.24411496116803175, -0.2398413319192482, -0.23556558153568086, -0.23128768437029487, -0.22700761424540192, -0.22272534440845224, -0.21844084748149653, -0.21415409540323377, -0.20986505936260938, -0.2055737097229461, -0.20128001593523584, -0.19698394643896713, -0.1926854685492052, -0.18838454832804036, -0.18408115043825612, -0.17977523797752787, -0.1754667722904798, -0.1711557127566336, -0.16684201655123157, -0.16252563837709888, -0.15820653022089518, -0.15388464081808634, -0.1495599155506559, -0.145232295874754, -0.14090171890830241, -0.1365681169414099, -0.13223141690757076, -0.127891539817789, -0.12354840016198708, -0.11920190528417055, -0.11485195474072903, -0.11049843965449317, -0.10614124208110137, -0.10178023440856637, -0.09741527881530304, -0.09304622681858288, -0.08867291895057794, -0.08429518460825249, -0.079912842132671, -0.07552569918723288, -0.07113355353533554, -0.06673619425989888, -0.06233340372218903, -0.05792496030144936, -0.05351064219723739, -0.049090232754745826, -0.04466352715306329, -0.0402303413437939, -0.03579052224281607, -0.03134395770180592, -0.026890580527705096, -0.022430352014029233, -0.0179631914508769, -0.013488783260745638, -0.009006138947192082, -0.004512641093960048, 5.2180482157381e-14 };
    
    std::shared_ptr<AbstractEvaluator> eval(new SaturationPressureEvaluator({ 1, 1.5, 3, 3.5, 4, 7.5 }));
    std::vector<std::shared_ptr<AbstractInput> > q;
    for (int i = 0; i < x.size(); ++i) {
        q.push_back(std::shared_ptr<AbstractInput>(new NumericInput(x[i], y[i])));
    }
    //std::vector<double> c = {-7.85951783, 1.84408259, -11.7866497, 22.6807411, -15.9618719, 1.80122502 };
    std::vector<double> c = { 1,1,1,1,1,1 };
    LevenbergMarquadt(eval, q, c);
    int rr = 0;
}

void run_LM(bool threading)
{
    std::shared_ptr<AbstractEvaluator> eval(new PolynomialEvaluator(2));
    std::vector<std::shared_ptr<AbstractInput> > q;
    long Nmax = 100000;
    for (double i = 0; i < Nmax; ++i) {
        double x = i / ((double)Nmax);
        double y = 1 + 2 * x + 3 * x*x;
        q.push_back(std::shared_ptr<AbstractInput>(new NumericInput(x, y)));
    }
    std::vector<double> c = { -10, -2, 2.5 };
    LevenbergMarquadt(eval, q, c);
}

// The runner, either with threading on or off
double doit(bool threading)
{
    std::shared_ptr<AbstractEvaluator> eval(new PolynomialEvaluator(2));
    
    std::vector<std::shared_ptr<AbstractInput> > q;
    long Nmax = 100;
    for (double i = 0; i < Nmax; ++i) {
        double x = i / ((double)Nmax);
        double y = 1 + 2 * x + 3 * x*x;
        q.push_back(std::shared_ptr<AbstractInput>(new NumericInput(x, y)));
    }
    
    std::vector<double> c = { -10, -2, 2.5 };
    eval->set_coefficients(c);
    
    auto startTime = std::chrono::system_clock::now();
    
    std::cout << "threading " << (threading ? "on" : "off") << "\n--------------------------\n";
    std::vector<std::shared_ptr<AbstractOutput> > outs;
    if (threading){
        short Nthread = std::thread::hardware_concurrency(); // 4 for me
        std::cout << "#threads: " << Nthread << "\n";
        outs = eval->evaluate_parallel(q, Nthread);
    }
    else {
        outs = eval->evaluate_serial(q, 0, Nmax);
    }
    double SOS = 0;
    for (auto &e : outs) {
        SOS += e->get_error();
    }
    std::cout << "result SOS: " << SOS << "\n";
    std::cout << "result length: " << outs.size() << "\n";
    
    auto endTime = std::chrono::system_clock::now();
    std::chrono::duration<double> elapsed_seconds = endTime - startTime;
    
    double elapsed_uscall = elapsed_seconds.count() / ((double)Nmax)*1e6;
    
    std::cout << "elapsed: " << elapsed_uscall << " us/call\n\n";
    return elapsed_uscall;
}

int main(){
    
    auto startTime = std::chrono::system_clock::now();
    fit_waterpanc();
    auto endTime = std::chrono::system_clock::now();
    std::chrono::duration<double> elapsed_seconds = endTime - startTime;
    double elapsed = elapsed_seconds.count() ;
    std::cout << "elapsed: " << elapsed << " s\n\n";
    
    auto t_thread = doit(true);
    auto t_nothread = doit(false);
    std::cout << "Speedup: " << t_nothread / t_thread << std::endl;
}